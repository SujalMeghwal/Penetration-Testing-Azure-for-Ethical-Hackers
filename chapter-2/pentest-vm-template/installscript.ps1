param (
    [Parameter(Mandatory = $true)]
    [string]$UserName
)

Write-Host "=== Enabling Windows features (Hyper-V, Containers, WSL) ==="

# Enable Hyper-V and Containers (for future nested / lab stuff)
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
Enable-WindowsOptionalFeature -Online -FeatureName Containers -All -NoRestart

# Enable WSL + VM platform
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

Write-Host "=== Installing Chocolatey and base tools ==="

# Install Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# Refresh PATH for current session
$env:PATH += ";$($env:ALLUSERSPROFILE)\chocolatey\bin"

# Core tools for pentest workstation on Windows
choco install git zip unzip vscode azure-cli httpie 7zip.install googlechrome setdefaultbrowser win-no-annoy python -y
choco install microsoftazurestorageexplorer -y

# Set Chrome as default browser
SetDefaultBrowser.exe HKLM "Google Chrome"

Write-Host "=== Configuring PowerShell Gallery and installing Az & AzureAD ==="

# Ensure NuGet provider
Install-PackageProvider -Name NuGet -Force -Scope AllUsers

# Make PSGallery trusted
Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted

# Update PowerShellGet (optional but nice)
Install-Module -Name PowerShellGet -Force -AllowClobber

# Install Az module with -AllowClobber
Install-Module -Name Az -Repository PSGallery -Force -AllowClobber

# Install AzureAD module
Install-Module -Name AzureAD -Repository PSGallery -Force

Write-Host "=== Setting up WSL with Ubuntu non-interactively ==="

$ubuntuUrl = "https://cloud-images.ubuntu.com/wsl/latest/ubuntu-wsl-latest-rootfs-amd64.tar.gz"
$ubuntuRoot = "C:\Ubuntu"
$ubuntuTar  = Join-Path $ubuntuRoot "ubuntu-rootfs.tar.gz"

# Prepare folder
New-Item -ItemType Directory -Force -Path $ubuntuRoot | Out-Null

Write-Host "Downloading Ubuntu rootfs from: $ubuntuUrl"
Invoke-WebRequest -Uri $ubuntuUrl -OutFile $ubuntuTar

# (Re)register the distro
wsl --unregister Ubuntu 2>$null
wsl --import Ubuntu $ubuntuRoot $ubuntuTar --version 2

Write-Host "=== Creating user 'sujal' with password 'root' in Ubuntu ==="

# Create user sujal with home directory and bash shell (ignore error if exists)
wsl -d Ubuntu -- bash -c "id sujal >/dev/null 2>&1 || useradd -m -s /bin/bash sujal"

# Set password to 'root'
wsl -d Ubuntu -- bash -c "echo 'sujal:root' | chpasswd"

# Set default user to sujal via /etc/wsl.conf
wsl -d Ubuntu -- bash -c "cat << 'EOF' | tee /etc/wsl.conf
[user]
default=sujal
EOF"

Write-Host "=== Updating Ubuntu and installing Azure CLI + pentest tools ==="

# Update & basic tools
wsl -d Ubuntu -- bash -c "apt update && apt upgrade -y"

# Common pentest tooling (tune as you like)
wsl -d Ubuntu -- bash -c 'apt install -y curl wget git nmap sqlmap gobuster ffuf nikto john hydra net-tools dnsutils whois'

# Install Azure CLI on Ubuntu
wsl -d Ubuntu -- bash -c "curl -sL https://aka.ms/InstallAzureCLIDeb | bash"

Write-Host "=== Verifying Azure CLI inside Ubuntu ==="

wsl -d Ubuntu -- bash -c "az version || echo 'AZURE CLI NOT INSTALLED CORRECTLY'"

Write-Host "=== All setup steps executed. System will reboot to finish feature enablement. ==="

Restart-Computer -Force
