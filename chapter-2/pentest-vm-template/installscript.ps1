param (
    $UserName
)

# Enable required features
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
Enable-WindowsOptionalFeature -Online -FeatureName Containers -All -NoRestart

# Install Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# Install common tools
choco install git zip unzip vscode azure-cli httpie 7zip.install googlechrome setdefaultbrowser win-no-annoy microsoftazurestorageexplorer -y

# Set Chrome as default
SetDefaultBrowser.exe HKLM "Google Chrome"

# Install Docker Engine (supported on Windows Server)
Install-PackageProvider -Name NuGet -Force
Install-Module -Name DockerMsftProvider -Repository PSGallery -Force
Install-Package -Name docker -ProviderName DockerMsftProvider -Force

# Optional: enable WinRM
Enable-PSRemoting -Force

########## ENABLE WSL ##########
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

########## DOWNLOAD UBUNTU ROOTFS ##########
$ubuntuUrl = "https://cloud-images.ubuntu.com/wsl/latest/ubuntu-wsl-latest-rootfs-amd64.tar.gz"
$ubuntuTar = "C:\Ubuntu\ubuntu.tar.gz"

New-Item -ItemType Directory -Force -Path "C:\Ubuntu" | Out-Null
Invoke-WebRequest -Uri $ubuntuUrl -OutFile $ubuntuTar

########## REGISTER WSL DISTRO ##########
wsl --unregister Ubuntu 2>$null
wsl --import Ubuntu "C:\Ubuntu" $ubuntuTar --version 2

########## CREATE USER + SET PASSWORD ##########
# Create user 'sujal' inside WSL
wsl -d Ubuntu -- bash -c "useradd -m sujal"

# Set password to 'root'
wsl -d Ubuntu -- bash -c "echo 'sujal:root' | chpasswd"

########## SET DEFAULT USER ##########
$wslconf = @"
[user]
default=sujal
"@
New-Item -Path "C:\Ubuntu\etc\wsl.conf" -ItemType File -Force -Value $wslconf

########## UPDATE UBUNTU ##########
wsl -d Ubuntu -- bash -c "apt update && apt upgrade -y"

# Restart to fully enable hyper-v, containers, docker engine
Restart-Computer -Force
